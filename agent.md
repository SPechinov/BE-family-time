# Agent - Инструкция по проекту

## Обзор проекта

**Название проекта:** be-family-time

**Назначение:** Backend API для семейного приложения "Family Time" — сервис для управления семейным временем и связью.

**Основные технологии:**
- **Язык:** TypeScript (Node.js)
- **Веб-фреймворк:** Fastify
- **База данных:** PostgreSQL
- **Кэш:** Redis
- **Валидация:** Zod
- **Аутентификация:** JWT (Access/Refresh токены)
- **Документация API:** Swagger/OpenAPI
- **Тестирование:** Jest
- **Логирование:** Pino
- **Контейнеризация:** Docker, Docker Compose

**Архитектура:**
Проект следует принципам чистой архитектуры (Clean Architecture) с разделением по слоям:
- **api/rest** — REST API слой (маршруты, контроллеры, схемы валидации)
- **domains** — доменная логика (репозитории, варианты использования, сервисы)
- **pkg** — общие утилиты и инфраструктурный код
- **config** — конфигурация приложения
- **types** — общие типы TypeScript

## Структура проекта

```
be-family-time/
├── config/                 # Конфигурационные файлы
│   └── env.yaml           # Основной конфиг (порты, URI, TTL, секреты)
├── src/
│   ├── api/
│   │   └── rest/
│   │       ├── composites/ # Композиторы маршрутов (например, AuthComposite)
│   │       ├── constants/  # Константы API
│   │       ├── hooks/      # Fastify hooks
│   │       ├── routes/     # Определение маршрутов
│   │       ├── schemas/    # Схемы валидации
│   │       └── utils/      # Утилиты API
│   ├── config/             # Загрузка и валидация конфигурации
│   ├── domains/
│   │   ├── repositories/   # Репозитории данных
│   │   │   ├── db/        # База данных
│   │   │   └── stores/    # Хранилища (например, Redis)
│   │   ├── useCases/      # Варианты использования
│   │   └── services/      # Доменные сервисы
│   ├── pkg/                # Общие пакеты/утилиты
│   │   ├── errors.ts      # Обработка ошибок
│   │   ├── postgres.ts    # Клиент PostgreSQL
│   │   ├── redis.ts       # Клиент Redis
│   │   ├── generators.ts  # Генераторы (код, токены)
│   │   ├── times.ts       # Работа со временем
│   │   ├── logger.ts      # Логгер
│   │   └── fastify.ts     # Настройка Fastify
│   ├── tests/             # Тесты
│   ├── types/             # Общие типы
│   └── index.ts           # Точка входа приложения
├── migrations/            # Миграции базы данных
├── docker-compose.yaml    # Docker Compose конфигурация
├── tsconfig.json          # TypeScript конфигурация
├── jest.config.js         # Jest конфигурация
├── nodemon.json           # Nodemon конфигурация
└── package.json           # Зависимости и скрипты
```

## Сборка и запуск

### Установка зависимостей
```bash
npm install
```

### Запуск в режиме разработки
```bash
npm run dev
```
Запускает приложение с hot-reload через nodemon. Приложение будет доступно на порту 8000 (по умолчанию).

### Сборка для продакшена
```bash
npm run build
```
Компилирует TypeScript код в директорию `dist/`.

### Запуск продакшн-сборки
```bash
npm run start
```
Запускает скомпилированный код из `dist/index.js`.

### Запуск с Docker Compose
```bash
docker-compose up -d
```
Запускает приложение вместе с PostgreSQL и Redis в контейнерах.

### Тестирование
```bash
npm run test
```
Запускает тесты через Jest.

### Линтинг
```bash
npm run lint
```
Проверяет код с помощью ESLint.

### Форматирование
```bash
npm run format
```
Форматирует код с помощью Prettier.

## Конфигурация

Основной конфигурационный файл: `config/env.yaml`

Ключевые настройки:
- **nodeEnv**: Окружение (`local`, `development`, `production`)
- **server.port**: Порт сервера (по умолчанию 8000)
- **postgres.uri**: Строка подключения к PostgreSQL
- **redis.uri**: Строка подключения к Redis
- **ttls**: Время жизни кодов подтверждения (регистрация, восстановление пароля)
- **codesLength**: Длина генерируемых кодов
- **salts**: Соли для хеширования и шифрования
- **jwt**: Настройки JWT токенов (секреты, время жизни, issuer)
- **cookie**: Секрет для cookie

Конфигурация загружается при старте и валидируется через Zod schema.

## API

API доступно по пути `/api` и включает:
- **Аутентификация**: Регистрация, вход, выход, подтверждение email, восстановление пароля
- **Документация**: Swagger UI доступен в режиме разработки

Для работы API требуются:
- PostgreSQL (для хранения данных пользователей)
- Redis (для сессий и временных данных)

## Правила разработки

### Стиль кодирования
- Проект использует TypeScript со строгой типизацией
- Форматирование кода через Prettier (конфигурация в `.prettierrc.js`)
- Линтинг через ESLint (конфигурация в `eslint.config.mjs`)
- Следуйте принципам чистой архитектуры (разделение слоёв)

### Тестирование
- Тесты пишутся с использованием Jest
- Тестовые файлы должны иметь суффикс `.test.ts`
- Тесты размещаются в директории `src/tests/` или рядом с тестируемым кодом
- Покрытие кода тестами собирается автоматически

### Структура кода
- Используйте псевдоним `@/` для импорта из директории `src/`
- Доменная логика должна находиться в `src/domains/`
- API слой должен быть отделён от бизнес-логики
- Репозитории отвечают за работу с данными
- Варианты использования (use cases) описывают бизнес-операции

### Коммиты
- Пишите понятные сообщения коммитов на русском или английском
- Следуйте соглашениям по формату коммитов, если они есть в проекте

## Зависимости

### Основные
- `fastify`: Высокопроизводительный веб-фреймворк
- `pg`: Клиент PostgreSQL
- `ioredis`: Клиент Redis
- `zod`: Валидация схем
- `jsonwebtoken`: Работа с JWT токенами
- `bcryptjs`: Хеширование паролей
- `pino`: Структурированное логирование
- `swagger-ui-fastify`: Документация API
- `js-yaml`: Парсинг YAML конфигурации

### Инструменты разработки
- `typescript`: Компилятор TypeScript
- `jest`: Фреймворк для тестирования
- `ts-jest`: Пресет для Jest с TypeScript
- `nodemon`: Автоматический перезапуск при изменениях
- `eslint`: Линтер
- `prettier`: Форматтер
- `@types/*`: TypeScript определения типов

## Дополнительные заметки

- Приложение поддерживает graceful shutdown (обработка SIGINT, SIGTERM)
- В режиме разработки логирование более детальное (debug level) с цветным выводом
- В продакшене логирование на уровне info
- Swagger UI автоматически генерируется из схем и доступен в dev режиме
- Используются composite pattern для организации маршрутов API
- Проект использует тесты, включая unit-тесты и тесты API
- Для генерации кодов и токенов используются специальные сервисы
- Используются rate limiters для защиты от злоупотреблений (например, частые запросы на регистрацию)
- Ошибки имеют четкую иерархию и коды, что упрощает отладку
- В dev-режиме OTP-коды возвращаются в заголовке X-Dev-Otp-Code
- Реализована защита от повторной регистрации с теми же контактами
- Используются строгие схемы валидации для всех входящих запросов
- Приложение структурировано по принципам чистой архитектуры, что обеспечивает гибкость и тестируемость
